import React, { useState, useRef } from 'react';
import {
  View,
  Text,
  TextInput,
  TouchableOpacity,
  ScrollView,
  StyleSheet,
  Alert,
  ActivityIndicator,
  Platform,
  FlatList,
  Dimensions,
  KeyboardAvoidingView,
} from 'react-native';
import { LinearGradient } from 'expo-linear-gradient';
import { Send, Sparkles, Crown, Share2 } from 'lucide-react-native';
import { useSettings } from '@/hooks/SettingsContext';
import { useRouter } from 'expo-router';
import { ShareModal } from '@/components/ShareModal';
import { REPHRASE_STYLES, getActiveStyles, getStyleById } from '@/config/styles';

const { width: screenWidth } = Dimensions.get('window');
const CARD_WIDTH = screenWidth * 0.62; // 62%„Å´Á∏ÆÂ∞èÔºàÂ∑¶Âè≥„Å´Ë¶ãÂàá„Çå„ÇãUXÔºâ
const CARD_SPACING = 16;

export default function RephraseScreen() {
  const { apiKey, isPro, rephraseCount, setRephraseCount } = useSettings();
  const router = useRouter();
  const [inputText, setInputText] = useState('');
  const [selectedStyleIndex, setSelectedStyleIndex] = useState(0);
  const [rephraseResult, setRephraseResult] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [showShareModal, setShowShareModal] = useState(false);
  const flatListRef = useRef<FlatList>(null);

  const activeStyles = getActiveStyles();
  const selectedStyle = activeStyles[selectedStyleIndex];

  // Ë©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞
  console.log('=== „Ç≥„Éà„Éê„ÇØ„É©„Éï„Éà „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†± ===');
  console.log('API Key Ë®≠ÂÆöÁä∂Ê≥Å:', apiKey ? `Ë®≠ÂÆöÊ∏à„Åø (${apiKey.substring(0, 7)}...)` : 'Êú™Ë®≠ÂÆö');
  console.log('ÈÅ∏Êäû‰∏≠„ÅÆ„Çπ„Çø„Ç§„É´:', selectedStyle);
  console.log('ÈÅ∏Êäû‰∏≠„ÅÆ„Çπ„Çø„Ç§„É´„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ:', selectedStyleIndex);
  console.log('„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çπ„Çø„Ç§„É´Êï∞:', activeStyles.length);
  console.log('ÂÖ®„Çπ„Çø„Ç§„É´Êï∞:', REPHRASE_STYLES.length);

  const handleRephrase = async () => {
    console.log('=== Ë®ÄË™ûÁîüÊàêÈñãÂßã ===');
    console.log('ÂÖ•Âäõ„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßã...');
    
    // API„Ç≠„Éº„ÅÆË©≥Á¥∞Á¢∫Ë™ç
    if (!apiKey || apiKey.trim() === '') {
      console.error('‚ùå API„Ç≠„Éº„ÅåÊú™Ë®≠ÂÆö');
      Alert.alert('API„Ç≠„ÉºÊú™Ë®≠ÂÆö', 'SettingsÁîªÈù¢„ÅßOpenAI API„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
      return;
    }
    console.log('‚úÖ API„Ç≠„ÉºÁ¢∫Ë™çÊ∏à„Åø');

    // ÁÑ°Êñô„É¶„Éº„Ç∂„Éº„ÅÆÂà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØ
    if (!isPro && rephraseCount >= 5) {
      console.log('‚ùå ÁÑ°ÊñôÁâà„ÅÆÂà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü');
      Alert.alert(
        'Âà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü',
        '5Âõû„Åæ„Åß„ÅÆÁÑ°ÊñôÂà©Áî®„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇÊúâÊñôÁâà„Å´„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Åó„Å¶Á∂ö„Åë„Å¶Âà©Áî®„Åß„Åç„Åæ„Åô„ÄÇ',
        [
          { text: '„Ç≠„É£„É≥„Çª„É´', style: 'cancel' },
          { 
            text: 'ÊúâÊñôÁâà„Å´„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ', 
            onPress: () => router.push('/settings')
          },
        ]
      );
      return;
    }
    console.log(`‚úÖ Âà©Áî®Âà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØÊ∏à„Åø (${rephraseCount}/5)`);

    // ÂÖ•ÂäõÊñáÁ´†„ÉÅ„Çß„ÉÉ„ÇØ
    if (!inputText.trim()) {
      console.error('‚ùå ÂÖ•ÂäõÊñáÁ´†„ÅåÁ©∫');
      Alert.alert('„Ç®„É©„Éº', 'ÊñáÁ´†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      return;
    }
    console.log('‚úÖ ÂÖ•ÂäõÊñáÁ´†Á¢∫Ë™çÊ∏à„Åø:', inputText);

    // „Çπ„Çø„Ç§„É´ÈÅ∏Êäû„ÉÅ„Çß„ÉÉ„ÇØ
    if (!selectedStyle) {
      console.error('‚ùå „Çπ„Çø„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
      console.error('selectedStyleIndex:', selectedStyleIndex);
      console.error('activeStyles:', activeStyles);
      Alert.alert('„Ç®„É©„Éº', '„Çπ„Çø„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      return;
    }
    console.log('‚úÖ „Çπ„Çø„Ç§„É´Á¢∫Ë™çÊ∏à„Åø:', selectedStyle.name);

    // „Éó„É≠„É≥„Éó„ÉàÁ¢∫Ë™ç
    if (!selectedStyle.prompt || selectedStyle.prompt.trim() === '') {
      console.error('‚ùå „Çπ„Çø„Ç§„É´„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÅåÁ©∫„Åß„Åô');
      console.error('selectedStyle.prompt:', selectedStyle.prompt);
      Alert.alert('„Ç®„É©„Éº', '„Çπ„Çø„Ç§„É´Ë®≠ÂÆö„Å´„Ç®„É©„Éº„Åå„ÅÇ„Çä„Åæ„Åô');
      return;
    }
    console.log('‚úÖ „Éó„É≠„É≥„Éó„ÉàÁ¢∫Ë™çÊ∏à„Åø:', selectedStyle.prompt);

    // API„É™„ÇØ„Ç®„Çπ„ÉàÊ∫ñÂÇô
    const systemMessage = '„ÅÇ„Å™„Åü„ÅØÊñáÁ´†„ÇíÊßò„ÄÖ„Å™„Çπ„Çø„Ç§„É´„ÅßË®Ä„ÅÑÊèõ„Åà„ÇãÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇÊåáÂÆö„Åï„Çå„Åü„Çπ„Çø„Ç§„É´„Å´Âæì„Å£„Å¶„ÄÅËá™ÁÑ∂„ÅßÈ≠ÖÂäõÁöÑ„Å™Êó•Êú¨Ë™û„ÅÆÊñáÁ´†„Å´Ë®Ä„ÅÑÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂÖÉ„ÅÆÊÑèÂë≥„Çí‰øù„Å°„Å™„Åå„Çâ„ÄÅÊåáÂÆö„Åï„Çå„Åü„Çπ„Çø„Ç§„É´„ÅÆÁâπÂæ¥„ÇíÊòéÁ¢∫„Å´Ë°®Áèæ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
    const userMessage = `${selectedStyle.prompt}\n\nÊñáÁ´†: ${inputText}`;
    
    const requestPayload = {
      model: 'gpt-4o',
      messages: [
        {
          role: 'system',
          content: systemMessage
        },
        {
          role: 'user',
          content: userMessage,
        },
      ],
      max_tokens: 500,
      temperature: 0.7,
    };

    console.log('üì§ API Request Payload:');
    console.log('Model:', requestPayload.model);
    console.log('System Message:', systemMessage);
    console.log('User Message:', userMessage);
    console.log('Full Payload:', JSON.stringify(requestPayload, null, 2));

    setIsLoading(true);
    try {
      console.log('üåê APIÂëº„Å≥Âá∫„ÅóÈñãÂßã...');
      
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`,
        },
        body: JSON.stringify(requestPayload),
      });

      console.log('üì• API Response Status:', response.status);
      console.log('üì• API Response Headers:', response.headers);

      const data = await response.json();
      console.log('üì• API Response Data:', JSON.stringify(data, null, 2));

      if (response.ok) {
        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
          console.error('‚ùå API ResponseÊßãÈÄ†„Åå‰∏çÊ≠£„Åß„Åô');
          console.error('choices:', data.choices);
          Alert.alert('„Ç®„É©„Éº', 'AI„Åã„Çâ„ÅÆÂøúÁ≠îÂΩ¢Âºè„Åå‰∏çÊ≠£„Åß„Åô');
          return;
        }

        const result = data.choices[0].message.content?.trim();
        if (!result) {
          console.error('‚ùå API ResponseÂÜÖÂÆπ„ÅåÁ©∫„Åß„Åô');
          console.error('message.content:', data.choices[0].message.content);
          Alert.alert('„Ç®„É©„Éº', 'AI„Åã„Çâ„ÅÆÂøúÁ≠î„ÅåÁ©∫„Åß„Åô');
          return;
        }

        console.log('‚úÖ ÁîüÊàêÁµêÊûú:', result);
        setRephraseResult(result);
        setRephraseCount(rephraseCount + 1);
        console.log('üéâ Ë®ÄË™ûÁîüÊàêÊàêÂäüÔºÅ');
      } else {
        console.error('‚ùå API Error Response:', data);
        if (response.status === 401) {
          console.error('‚ùå Ë™çË®º„Ç®„É©„Éº: API„Ç≠„Éº„ÅåÁÑ°Âäπ');
          Alert.alert('API„Ç≠„Éº„Ç®„É©„Éº', 'API„Ç≠„Éº„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇSettingsÁîªÈù¢„ÅßÊ≠£„Åó„ÅÑAPI„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        } else if (response.status === 429) {
          console.error('‚ùå „É¨„Éº„ÉàÂà∂Èôê„Ç®„É©„Éº');
          Alert.alert('„Ç®„É©„Éº', 'API„ÅÆÂà©Áî®Âà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        } else if (response.status === 500) {
          console.error('‚ùå „Çµ„Éº„Éê„Éº„Ç®„É©„Éº');
          Alert.alert('„Ç®„É©„Éº', 'OpenAI„Çµ„Éº„Éê„Éº„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        } else {
          console.error('‚ùå „Åù„ÅÆ‰ªñ„ÅÆAPI„Ç®„É©„Éº');
          Alert.alert('„Ç®„É©„Éº', data.error?.message || `Âá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü (${response.status})`);
        }
      }
    } catch (error) {
      console.error('‚ùå Network Error:', error);
      console.error('Error details:', {
        name: error instanceof Error ? error.name : 'Unknown',
        message: error instanceof Error ? error.message : 'Unknown error',
        stack: error instanceof Error ? error.stack : 'No stack trace'
      });
      Alert.alert('„Ç®„É©„Éº', '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    } finally {
      setIsLoading(false);
      console.log('=== Ë®ÄË™ûÁîüÊàêÂá¶ÁêÜÂÆå‰∫Ü ===');
    }
  };

  const handleShare = () => {
    setShowShareModal(true);
  };

  const navigateToSettings = () => {
    router.push('/settings');
  };

  const onStyleSelect = (index: number) => {
    console.log('„Çπ„Çø„Ç§„É´ÈÅ∏Êäû:', activeStyles[index]?.name || 'undefined');
    setSelectedStyleIndex(index);
    flatListRef.current?.scrollToIndex({ 
      index, 
      animated: true,
      viewPosition: 0.5 
    });
  };

  const renderStyleCard = ({ item, index }: { item: any; index: number }) => {
    const isSelected = selectedStyleIndex === index;
    
    return (
      <TouchableOpacity
        style={[
          styles.styleCard,
          isSelected && styles.selectedStyleCard,
          { backgroundColor: isSelected ? item.color : '#ffffff' }
        ]}
        onPress={() => onStyleSelect(index)}
        activeOpacity={0.8}
      >
        <View style={styles.styleCardContent}>
          <Text style={styles.styleEmoji}>{item.emoji}</Text>
          <Text style={[
            styles.styleCardTitle,
            { color: isSelected ? '#ffffff' : '#1f2937' }
          ]}>{item.name}</Text>
          <Text style={[
            styles.styleCardDescription,
            { color: isSelected ? 'rgba(255,255,255,0.9)' : '#6b7280' }
          ]}>{item.description}</Text>
          
          {/* „Ç´„ÉÜ„Ç¥„É™„Éº„Éê„ÉÉ„Ç∏ */}
          {item.category && (
            <View style={[
              styles.categoryBadge,
              { backgroundColor: isSelected ? 'rgba(255,255,255,0.2)' : '#f3f4f6' }
            ]}>
              <Text style={[
                styles.categoryText,
                { color: isSelected ? '#ffffff' : '#6b7280' }
              ]}>
                {item.category === 'popular' ? '‰∫∫Ê∞ó' : 
                 item.category === 'creative' ? '„ÇØ„É™„Ç®„Ç§„ÉÜ„Ç£„Éñ' :
                 item.category === 'business' ? '„Éì„Ç∏„Éç„Çπ' : 'Ê•Ω„Åó„ÅÑ'}
              </Text>
            </View>
          )}
          
          {/* ÊúüÈñìÈôêÂÆö„Éê„ÉÉ„Ç∏ */}
          {item.isLimited && (
            <View style={styles.limitedBadge}>
              <Text style={styles.limitedText}>ÊúüÈñìÈôêÂÆö</Text>
            </View>
          )}
        </View>
      </TouchableOpacity>
    );
  };

  const remainingCount = Math.max(0, 5 - rephraseCount);
  const showLimitWarning = !isPro && rephraseCount >= 4;

  return (
    <KeyboardAvoidingView 
      style={styles.container} 
      behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
    >
      <LinearGradient colors={['#8B5CF6', '#EC4899', '#F59E0B']} style={styles.container}>
        {/* „Éò„ÉÉ„ÉÄ„Éº */}
        <View style={styles.header}>
          <Text style={styles.title}>„Ç≥„Éà„Éê„ÇØ„É©„Éï„Éà</Text>
          <Text style={styles.subtitle}>AI„ÅåÊñáÁ´†„ÇíÊßò„ÄÖ„Å™„Çπ„Çø„Ç§„É´„ÅßÂ§âÊèõ„Åó„Åæ„Åô</Text>
          
          {/* „Éó„É©„É≥Ë°®Á§∫ */}
          <View style={styles.planIndicator}>
            {isPro ? (
              <View style={styles.proIndicator}>
                <Crown size={16} color="#F59E0B" />
                <Text style={styles.proText}>ProÁâà - ÁÑ°Âà∂Èôê</Text>
              </View>
            ) : (
              <View style={styles.freeIndicator}>
                <Text style={styles.freeText}>
                  ÁÑ°ÊñôÁâà: {remainingCount}Âõû ÊÆã„Çä
                </Text>
                {showLimitWarning && (
                  <Text style={styles.warningText}>„ÇÇ„ÅÜ„Åô„ÅêÂà∂Èôê„Å´ÈÅî„Åó„Åæ„Åô</Text>
                )}
              </View>
            )}
          </View>
        </View>

        {/* Âà∂ÈôêË≠¶Âëä„Ç´„Éº„Éâ */}
        {!isPro && rephraseCount >= 3 && (
          <View style={styles.warningCard}>
            <View style={styles.warningHeader}>
              <Crown size={20} color="#F59E0B" />
              <Text style={styles.warningTitle}>Âà∂Èôê„Å´„ÅîÊ≥®ÊÑè„Åè„Å†„Åï„ÅÑ</Text>
            </View>
            <Text style={styles.warningDescription}>
              ÁÑ°ÊñôÁâà„ÅØ1Êó•5Âõû„Åæ„Åß„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÄÇ
              {remainingCount > 0 
                ? `„ÅÇ„Å®${remainingCount}ÂõûÂà©Áî®ÂèØËÉΩ„Åß„Åô„ÄÇ` 
                : 'Êú¨Êó•„ÅÆÂà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ'
              }
            </Text>
            <TouchableOpacity style={styles.upgradePrompt} onPress={navigateToSettings}>
              <Text style={styles.upgradePromptText}>ÊúâÊñôÁâà„ÅßÁÑ°Âà∂ÈôêÂà©Áî® ‚Üí</Text>
            </TouchableOpacity>
          </View>
        )}

        {/* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ */}
        <View style={styles.contentContainer}>
          {/* ‰∏äÈÉ®„Çπ„ÇØ„É≠„Éº„É´„Ç®„É™„Ç¢ */}
          <ScrollView style={styles.scrollView} showsVerticalScrollIndicator={false}>
            <View style={styles.mainCard}>
              {/* ÊñáÁ´†ÂÖ•Âäõ */}
              <View style={styles.inputSection}>
                <Text style={styles.sectionTitle}>ÊñáÁ´†„ÇíÂÖ•Âäõ</Text>
                <TextInput
                  style={styles.textInput}
                  placeholder="‰æã: ‰ªäÊó•„ÅØ„ÅÑ„ÅÑÂ§©Ê∞ó„Åß„Åô„Å≠"
                  value={inputText}
                  onChangeText={setInputText}
                  multiline
                  numberOfLines={4}
                  placeholderTextColor="#9ca3af"
                />
              </View>

              {/* Ê®™„Çπ„ÉØ„Ç§„Éó „É™„Éº„É´UI „Çπ„Çø„Ç§„É´ÈÅ∏Êäû */}
              <View style={styles.styleSection}>
                <Text style={styles.sectionTitle}>„Çπ„Çø„Ç§„É´„ÇíÈÅ∏Êäû</Text>
                <Text style={styles.styleSectionSubtitle}>
                  „Çπ„ÉØ„Ç§„Éó„ÅßÊñáÂåñÁöÑ„Çπ„Çø„Ç§„É´„ÇíÊé¢Á¥¢„Åó„Çà„ÅÜÔºÅ
                </Text>
                
                {/* „É™„Éº„É´È¢®„ÅÆÊ®™„Çπ„ÉØ„Ç§„ÉóUI */}
                <View style={styles.reelContainer}>
                  <FlatList
                    ref={flatListRef}
                    data={activeStyles}
                    renderItem={renderStyleCard}
                    keyExtractor={(item) => item.id}
                    horizontal
                    showsHorizontalScrollIndicator={false}
                    snapToInterval={CARD_WIDTH + CARD_SPACING}
                    decelerationRate="fast"
                    contentContainerStyle={styles.styleCarousel}
                    onMomentumScrollEnd={(event) => {
                      const index = Math.round(event.nativeEvent.contentOffset.x / (CARD_WIDTH + CARD_SPACING));
                      if (index !== selectedStyleIndex && index >= 0 && index < activeStyles.length) {
                        setSelectedStyleIndex(index);
                      }
                    }}
                    getItemLayout={(data, index) => ({
                      length: CARD_WIDTH + CARD_SPACING,
                      offset: (CARD_WIDTH + CARD_SPACING) * index,
                      index,
                    })}
                  />
                  
                  {/* „Çπ„ÉØ„Ç§„Éó„Éí„É≥„Éà */}
                  <View style={styles.swipeHint}>
                    <Text style={styles.swipeHintText}>‚Üê „Çπ„ÉØ„Ç§„Éó„ÅßÊé¢Á¥¢ ‚Üí</Text>
                  </View>
                  
                  {/* „Çπ„Çø„Ç§„É´„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */}
                  <View style={styles.styleIndicator}>
                    {activeStyles.map((_, index) => (
                      <View
                        key={index}
                        style={[
                          styles.indicatorDot,
                          { backgroundColor: index === selectedStyleIndex ? '#8B5CF6' : '#e5e7eb' }
                        ]}
                      />
                    ))}
                  </View>
                </View>
              </View>

              {/* Â§âÊèõÁµêÊûú */}
              {rephraseResult ? (
                <View style={styles.resultSection}>
                  <View style={styles.resultHeader}>
                    <Sparkles size={20} color="#8B5CF6" />
                    <Text style={styles.sectionTitle}>Â§âÊèõÁµêÊûú</Text>
                    <View style={styles.resultStyleTag}>
                      <Text style={styles.resultStyleText}>{selectedStyle.name}</Text>
                    </View>
                  </View>
                  <View style={styles.resultContainer}>
                    <Text style={styles.resultText}>{rephraseResult}</Text>
                    <TouchableOpacity style={styles.shareButton} onPress={handleShare}>
                      <Share2 size={16} color="#EC4899" />
                      <Text style={styles.shareButtonText}>SNS„Åß„Ç∑„Çß„Ç¢</Text>
                    </TouchableOpacity>
                  </View>
                </View>
              ) : null}
            </View>
          </ScrollView>

          {/* Âõ∫ÂÆöÂ§âÊèõ„Éú„Çø„É≥ */}
          <View style={styles.fixedButtonContainer}>
            <TouchableOpacity
              style={[styles.rephraseButton, isLoading && styles.disabledButton]}
              onPress={handleRephrase}
              disabled={isLoading}
              activeOpacity={0.8}
            >
              <LinearGradient colors={['#8B5CF6', '#EC4899']} style={styles.buttonGradient}>
                {isLoading
                  ? <ActivityIndicator color="#fff" size="small" />
                  : <Send size={20} color="#fff" />
                }
                <Text style={styles.rephraseButtonText}>
                  {isLoading ? 'Â§âÊèõ‰∏≠...' : '‚ú® Â§âÊèõ„Åô„Çã'}
                </Text>
                {!isPro && (
                  <Text style={styles.countText}>
                    ({rephraseCount}/5)
                  </Text>
                )}
              </LinearGradient>
            </TouchableOpacity>
          </View>
        </View>

        <ShareModal
          visible={showShareModal}
          onClose={() => setShowShareModal(false)}
          rephraseText={rephraseResult}
          style={selectedStyle?.id || 'meigen'}
          onUpgradePress={() => {
            setShowShareModal(false);
            navigateToSettings();
          }}
        />
      </LinearGradient>
    </KeyboardAvoidingView>
  );
}

const styles = StyleSheet.create({
  container: { 
    flex: 1 
  },
  header: { 
    alignItems: 'center', 
    paddingTop: Platform.OS === 'ios' ? 60 : 40,
    paddingBottom: 24, 
    paddingHorizontal: 20 
  },
  title: { 
    fontSize: 36, 
    fontFamily: 'Inter-Bold', 
    color: '#fff', 
    textAlign: 'center', 
    marginBottom: 8,
    letterSpacing: 1,
  },
  subtitle: { 
    fontSize: 16, 
    fontFamily: 'Inter-Regular', 
    color: '#fff', 
    textAlign: 'center', 
    opacity: 0.9, 
    marginBottom: 16 
  },
  planIndicator: {
    alignItems: 'center',
  },
  proIndicator: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: 'rgba(255, 255, 255, 0.2)',
    paddingHorizontal: 12,
    paddingVertical: 6,
    borderRadius: 16,
    gap: 6,
  },
  proText: {
    fontSize: 14,
    fontFamily: 'Inter-SemiBold',
    color: '#ffffff',
  },
  freeIndicator: {
    alignItems: 'center',
  },
  freeText: {
    fontSize: 14,
    fontFamily: 'Inter-Medium',
    color: '#ffffff',
    opacity: 0.9,
  },
  warningText: {
    fontSize: 12,
    fontFamily: 'Inter-Regular',
    color: '#FCD34D',
    marginTop: 2,
  },
  warningCard: {
    backgroundColor: '#FEF3C7',
    marginHorizontal: 20,
    marginBottom: 20,
    borderRadius: 16,
    padding: 16,
    borderWidth: 1,
    borderColor: '#F59E0B',
  },
  warningHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    marginBottom: 8,
  },
  warningTitle: {
    fontSize: 16,
    fontFamily: 'Inter-SemiBold',
    color: '#92400E',
  },
  warningDescription: {
    fontSize: 14,
    fontFamily: 'Inter-Regular',
    color: '#92400E',
    lineHeight: 20,
    marginBottom: 12,
  },
  upgradePrompt: {
    alignSelf: 'flex-start',
  },
  upgradePromptText: {
    fontSize: 14,
    fontFamily: 'Inter-SemiBold',
    color: '#F59E0B',
    textDecorationLine: 'underline',
  },
  contentContainer: {
    flex: 1,
    flexDirection: 'column',
  },
  scrollView: { 
    flex: 1,
  },
  mainCard: { 
    backgroundColor: '#fff', 
    marginHorizontal: 20, 
    marginBottom: 20, 
    borderRadius: 20, 
    padding: 24, 
    shadowColor: '#000', 
    shadowOffset: { width: 0, height: 6 }, 
    shadowOpacity: 0.15, 
    shadowRadius: 12, 
    elevation: 8 
  },
  inputSection: {
    marginBottom: 32,
  },
  sectionTitle: { 
    fontSize: 18, 
    fontFamily: 'Inter-SemiBold', 
    color: '#1f2937', 
    marginBottom: 16 
  },
  textInput: { 
    borderWidth: 1, 
    borderColor: '#e5e7eb', 
    borderRadius: 12, 
    padding: 16, 
    fontSize: 16, 
    fontFamily: 'Inter-Regular', 
    color: '#1f2937', 
    backgroundColor: '#f9fafb', 
    minHeight: 100, 
    textAlignVertical: 'top' 
  },
  styleSection: {
    marginBottom: 32,
  },
  styleSectionSubtitle: {
    fontSize: 14,
    fontFamily: 'Inter-Regular',
    color: '#6b7280',
    marginBottom: 16,
    textAlign: 'center',
  },
  reelContainer: {
    position: 'relative',
  },
  styleCarousel: {
    paddingHorizontal: 10,
  },
  styleCard: {
    width: CARD_WIDTH,
    marginHorizontal: CARD_SPACING / 2,
    borderRadius: 20,
    padding: 20,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 6 },
    shadowOpacity: 0.15,
    shadowRadius: 12,
    elevation: 8,
    borderWidth: 2,
    borderColor: '#e5e7eb',
    minHeight: 180,
  },
  selectedStyleCard: {
    shadowOpacity: 0.25,
    shadowRadius: 16,
    elevation: 12,
    borderColor: 'transparent',
    transform: [{ scale: 1.02 }],
  },
  styleCardContent: {
    alignItems: 'center',
    justifyContent: 'center',
    flex: 1,
    position: 'relative',
  },
  styleEmoji: {
    fontSize: 36,
    marginBottom: 12,
  },
  styleCardTitle: {
    fontSize: 18,
    fontFamily: 'Inter-Bold',
    marginBottom: 6,
    textAlign: 'center',
  },
  styleCardDescription: {
    fontSize: 13,
    fontFamily: 'Inter-Regular',
    textAlign: 'center',
    lineHeight: 18,
    marginBottom: 10,
  },
  categoryBadge: {
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 8,
    marginBottom: 4,
  },
  categoryText: {
    fontSize: 11,
    fontFamily: 'Inter-Medium',
  },
  limitedBadge: {
    position: 'absolute',
    top: -8,
    right: -8,
    backgroundColor: '#EF4444',
    paddingHorizontal: 6,
    paddingVertical: 2,
    borderRadius: 8,
  },
  limitedText: {
    fontSize: 10,
    fontFamily: 'Inter-Bold',
    color: '#ffffff',
  },
  swipeHint: {
    alignItems: 'center',
    marginTop: 12,
  },
  swipeHintText: {
    fontSize: 12,
    fontFamily: 'Inter-Regular',
    color: '#9ca3af',
    fontStyle: 'italic',
  },
  styleIndicator: {
    flexDirection: 'row',
    justifyContent: 'center',
    alignItems: 'center',
    marginTop: 16,
    gap: 8,
  },
  indicatorDot: {
    width: 8,
    height: 8,
    borderRadius: 4,
  },
  resultSection: {
    borderTopWidth: 1,
    borderTopColor: '#e5e7eb',
    paddingTop: 24,
  },
  resultHeader: { 
    flexDirection: 'row', 
    alignItems: 'center', 
    gap: 8, 
    marginBottom: 16 
  },
  resultStyleTag: {
    marginLeft: 'auto',
    backgroundColor: '#f3f4f6',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 8,
    borderWidth: 1,
    borderColor: '#8B5CF6',
  },
  resultStyleText: {
    fontSize: 12,
    fontFamily: 'Inter-SemiBold',
    color: '#8B5CF6',
  },
  resultContainer: { 
    position: 'relative' 
  },
  resultText: { 
    fontSize: 16, 
    fontFamily: 'Inter-Regular', 
    color: '#1f2937', 
    lineHeight: 24, 
    marginBottom: 20, 
    padding: 16, 
    backgroundColor: '#f9fafb', 
    borderRadius: 12, 
    borderWidth: 1, 
    borderColor: '#e5e7eb' 
  },
  shareButton: { 
    flexDirection: 'row', 
    alignItems: 'center', 
    justifyContent: 'center', 
    gap: 8, 
    padding: 16, 
    backgroundColor: '#fdf2f8', 
    borderRadius: 12, 
    borderWidth: 1, 
    borderColor: '#EC4899' 
  },
  shareButtonText: { 
    fontSize: 16, 
    fontFamily: 'Inter-SemiBold', 
    color: '#EC4899' 
  },
  fixedButtonContainer: {
    paddingHorizontal: 20,
    paddingVertical: 16,
    backgroundColor: 'transparent',
  },
  rephraseButton: { 
    borderRadius: 16, 
    overflow: 'hidden', 
    shadowColor: '#000', 
    shadowOffset: { width: 0, height: 4 }, 
    shadowOpacity: 0.2, 
    shadowRadius: 8, 
    elevation: 5 
  },
  disabledButton: { 
    opacity: 0.7 
  },
  buttonGradient: { 
    flexDirection: 'row', 
    alignItems: 'center', 
    justifyContent: 'center', 
    paddingVertical: 18, 
    paddingHorizontal: 24, 
    gap: 8 
  },
  rephraseButtonText: { 
    fontSize: 18, 
    fontFamily: 'Inter-SemiBold', 
    color: '#fff' 
  },
  countText: { 
    fontSize: 14, 
    fontFamily: 'Inter-Regular', 
    color: '#fff', 
    opacity: 0.8 
  },
});